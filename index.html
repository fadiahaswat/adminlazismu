<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Lazismu Mu'allimin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out forwards;
        }
        .modal {
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Kontainer tabel agar bisa di-scroll di mobile */
        .table-wrapper {
            overflow-x: auto;
        }
        /* Tinggi maksimum untuk modal edit agar bisa di-scroll */
        .modal-body-scroll {
             max-height: 70vh;
             overflow-y: auto;
        }
        /* Statistik Ringkas */
        .stat-card {
            padding: 1rem; /* p-4 */
        }
        .stat-card-icon-wrapper {
            width: 3.5rem; /* w-14 */
            height: 3.5rem; /* h-14 */
        }
        .stat-card-icon {
            font-size: 1.5rem; /* text-2xl */
        }
        .stat-card-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4B5563; /* text-gray-600 */
        }
        .stat-card-value {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #1F2937; /* text-gray-800 */
        }
        /* Menghilangkan panah di input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <!-- MODAL ALERT (Sukses/Error) -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4 modal opacity-0">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center modal-content scale-95 opacity-0">
            <i id="alert-modal-icon" class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
            <h3 id="alert-modal-title" class="text-xl font-bold text-gray-800 mb-2">Sukses</h3>
            <p id="alert-modal-message" class="text-gray-600 mb-6">Pesan di sini.</p>
            <button id="alert-modal-close" class="bg-orange-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-orange-600 transition-colors">
                Tutup
            </button>
        </div>
    </div>

    <!-- MODAL KONFIRMASI (Hapus) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[99] flex items-center justify-center p-4 modal opacity-0">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center modal-content scale-95 opacity-0">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Anda Yakin?</h3>
            <p id="confirm-modal-message" class="text-gray-600 mb-6">Anda akan menghapus data ini secara permanen. Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                    Batal
                </button>
                <button id="confirm-modal-ok" class="bg-red-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-red-700 transition-colors">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT DONASI -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[98] flex items-center justify-center p-4 modal opacity-0">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl modal-content scale-95 opacity-0 flex flex-col">
            <form id="edit-form">
                <!-- Header Modal Edit -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200 sticky top-0 bg-white rounded-t-2xl">
                    <h3 class="text-2xl font-bold text-gray-800">Edit Donasi</h3>
                    <button id="edit-modal-close" type="button" class="text-gray-400 hover:text-gray-800 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Body Modal Edit (Scrollable) -->
                <div class="p-6 space-y-4 modal-body-scroll">
                    <input type="hidden" id="edit-row-number">
                    
                    <fieldset class="border border-gray-300 rounded-lg p-4">
                        <legend class="text-lg font-semibold text-gray-700 px-2">Detail Donasi</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                            <div>
                                <label for="edit-JenisDonasi" class="block text-sm font-medium text-gray-700 mb-1">Jenis Donasi</label>
                                <input type="text" id="edit-JenisDonasi" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label for="edit-Nominal" class="block text-sm font-medium text-gray-700 mb-1">Nominal</label>
                                <input type="number" id="edit-Nominal" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label for="edit-MetodePembayaran" class="block text-sm font-medium text-gray-700 mb-1">Metode Pembayaran</label>
                                <select id="edit-MetodePembayaran" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500 bg-white">
                                    <option value="Transfer">Transfer</option>
                                    <option value="QRIS">QRIS</option>
                                    <option value="Tunai">Tunai</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="border border-gray-300 rounded-lg p-4">
                        <legend class="text-lg font-semibold text-gray-700 px-2">Data Donatur</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="edit-NamaDonatur" class="block text-sm font-medium text-gray-700 mb-1">Nama Donatur</label>
                                <input type="text" id="edit-NamaDonatur" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                             <div>
                                <label for="edit-NoHP" class="block text-sm font-medium text-gray-700 mb-1">No. HP</label>
                                <input type="tel" id="edit-NoHP" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                             <div>
                                <label for="edit-Email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="edit-Email" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                             <div>
                                <label for="edit-NoKTP" class="block text-sm font-medium text-gray-700 mb-1">No. KTP</label>
                                <input type="text" id="edit-NoKTP" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="edit-Alamat" class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                                <textarea id="edit-Alamat" rows="2" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                            </div>
                        </div>
                    </fieldset>
                    
                    <fieldset class="border border-gray-300 rounded-lg p-4">
                        <legend class="text-lg font-semibold text-gray-700 px-2">Detail Kategori</legend>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="edit-TipeDonatur" class="block text-sm font-medium text-gray-700 mb-1">Tipe Donatur</label>
                                <select id="edit-TipeDonatur" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500 bg-white">
                                    <option value="santri">Santri</option>
                                    <option value="alumni">Alumni</option>
                                    <option value="umum">Umum</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-DetailAlumni" class="block text-sm font-medium text-gray-700 mb-1">Detail Alumni (Tahun Lulus)</label>
                                <input type="text" id="edit-DetailAlumni" placeholder="Cth: 2005" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label for="edit-NamaSantri" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label>
                                <input type="text" id="edit-NamaSantri" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label for="edit-NISSantri" class="block text-sm font-medium text-gray-700 mb-1">NIS Santri</label>
                                <input type="text" id="edit-NISSantri" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label for="edit-KelasSantri" class="block text-sm font-medium text-gray-700 mb-1">Kelas Santri</Vlabel>
                                <input type="text" id="edit-KelasSantri" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                    </fieldset>
                   
                    <div>
                        <label for="edit-PesanDoa" class="block text-sm font-medium text-gray-700 mb-1">Pesan/Doa</label>
                        <textarea id="edit-PesanDoa" rows="3" class="w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                    </div>
                </div>

                <!-- Footer Modal Edit -->
                <div class="flex justify-end items-center p-6 border-t border-gray-200 sticky bottom-0 bg-gray-50 rounded-b-2xl">
                    <button id="edit-modal-cancel" type="button" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-300 transition-colors mr-3">
                        Batal
                    </button>
                    <button id="edit-modal-save" type="submit" class="bg-green-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-green-700 transition-colors flex items-center disabled:opacity-75">
                        <span id="edit-save-text">Simpan Perubahan</span>
                        <span id="edit-save-loading" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- HEADER UTAMA -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center space-x-2">
                <i class="fas fa-hand-holding-heart text-orange-500"></i>
                <span>Admin <span class="text-orange-500">Dashboard</span></span>
            </h1>
            <div class="flex space-x-3">
                 <button id="export-csv-button" class="flex items-center space-x-2 bg-green-600 text-white px-5 py-2 rounded-full font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                    <i class="fas fa-file-excel"></i>
                    <span>Ekspor CSV</span>
                </button>
                <button id="refresh-button" class="flex items-center space-x-2 bg-orange-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-orange-600 transition duration-300 shadow-md">
                    <i id="refresh-icon" class="fas fa-sync-alt"></i>
                    <span>Refresh Data</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 md:px-6 py-8">

        <!-- KONTainer STATISTIK -->
        <div id="admin-stats-container" class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Statistik (Berdasarkan Filter)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- Stat Total Donasi -->
                <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center space-x-4 border-l-4 border-orange-500 stat-card">
                    <div class="bg-orange-500/10 rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center text-orange-500 stat-card-icon-wrapper">
                        <i class="fas fa-coins text-2xl stat-card-icon"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 stat-card-title">Total Donasi</p>
                        <h3 id="admin-stat-total" class="text-2xl font-bold text-gray-800 stat-card-value">Rp 0</h3>
                    </div>
                </div>
                <!-- Stat Total Donatur -->
                <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center space-x-4 border-l-4 border-blue-500 stat-card">
                    <div class="bg-blue-500/10 rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center text-blue-500 stat-card-icon-wrapper">
                        <i class="fas fa-user-check text-2xl stat-card-icon"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 stat-card-title">Total Transaksi</p>
                        <h3 id="admin-stat-donatur" class="text-2xl font-bold text-gray-800 stat-card-value">0</h3>
                    </div>
                </div>
                <!-- Stat Donasi Tertinggi -->
                <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center space-x-4 border-l-4 border-green-500 stat-card">
                    <div class="bg-green-500/10 rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center text-green-500 stat-card-icon-wrapper">
                        <i class="fas fa-arrow-up text-2xl stat-card-icon"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 stat-card-title">Donasi Tertinggi</p>
                        <h3 id="admin-stat-tertinggi" class="text-2xl font-bold text-gray-800 stat-card-value">Rp 0</h3>
                    </div>
                </div>
                <!-- Stat Donasi Rata-rata -->
                <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center space-x-4 border-l-4 border-purple-500 stat-card">
                    <div class="bg-purple-500/10 rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center text-purple-500 stat-card-icon-wrapper">
                        <i class="fas fa-divide text-2xl stat-card-icon"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 stat-card-title">Donasi Rata-rata</p>
                        <h3 id="admin-stat-rata" class="text-2xl font-bold text-gray-800 stat-card-value">Rp 0</h3>
                    </div>
                </div>
                <!-- Stat Donasi Hari Ini -->
                <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center space-x-4 border-l-4 border-yellow-500 stat-card">
                    <div class="bg-yellow-500/10 rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center text-yellow-500 stat-card-icon-wrapper">
                        <i class="fas fa-calendar-day text-2xl stat-card-icon"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 stat-card-title">Donasi Hari Ini</p>
                        <h3 id="admin-stat-hari-ini" class="text-2xl font-bold text-gray-800 stat-card-value">Rp 0</h3>
                    </div>
                </div>
                 <!-- Stat Tipe Terbanyak -->
                <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center space-x-4 border-l-4 border-teal-500 stat-card">
                    <div class="bg-teal-500/10 rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center text-teal-500 stat-card-icon-wrapper">
                        <i class="fas fa-users text-2xl stat-card-icon"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 stat-card-title">Tipe Donatur Terbanyak</p>
                        <h3 id="admin-stat-tipe" class="text-2xl font-bold text-gray-800 stat-card-value">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- KONTainer KONTEN UTAMA (Filter + Tabel) -->
        <div id="admin-content" class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Panel Filter -->
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Riwayat Donasi Masuk</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                    <!-- Filter Search -->
                    <div>
                        <label for="filter-search" class="block text-sm font-medium text-gray-700 mb-1">Cari (Nama, NIS, HP, Email)</label>
                        <input type="text" id="filter-search" placeholder="Ketik untuk mencari..." class="w-full border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <!-- Filter Tanggal Dari -->
                    <div>
                        <label for="filter-date-from" class="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label>
                        <input type="date" id="filter-date-from" class="w-full border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <!-- Filter Tanggal Sampai -->
                    <div>
                        <label for="filter-date-to" class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                        <input type="date" id="filter-date-to" class="w-full border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500">
                    </div>
                     <!-- Filter Jenis Donasi -->
                    <div>
                        <label for="filter-jenis" class="block text-sm font-medium text-gray-700 mb-1">Jenis Donasi</LabeL>
                        <select id="filter-jenis" class="w-full border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500 bg-white">
                            <option value="">Semua Jenis</option>
                        </select>
                    </div>
                    <!-- Filter Tipe Donatur -->
                    <div>
                        <label for="filter-tipe" class="block text-sm font-medium text-gray-700 mb-1">Tipe Donatur</LabeL>
                        <select id="filter-tipe" class="w-full border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500 bg-white">
                            <option value="">Semua Tipe</option>
                        </select>
                    </div>
                    <!-- Filter Metode Bayar -->
                     <div>
                        <label for="filter-metode" class="block text-sm font-medium text-gray-700 mb-1">Metode Pembayaran</LabeL>
                        <select id="filter-metode" class="w-full border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500 bg-white">
                            <option value="">Semua Metode</option>
                        </select>
                    </div>
                    <!-- Tombol Aksi Filter -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-2 flex items-end space-x-3">
                        <button id="filter-apply-button" class="w-full bg-blue-600 text-white px-5 py-2 rounded-full font-semibold hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center">
                            <i class="fas fa-filter mr-2"></i> Terapkan Filter
                        </button>
                        <button id="filter-reset-button" class="w-full bg-gray-200 text-gray-700 px-5 py-2 rounded-full font-semibold hover:bg-gray-300 transition duration-300">
                            Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Loading/Error/No Data -->
            <div id="admin-loading" class="p-12 flex flex-col items-center justify-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-4 text-orange-500"></i>
                <p class="font-semibold text-lg">Memuat data donasi...</p>
            </div>
            <div id="admin-error" class="hidden p-12 flex flex-col items-center justify-center text-red-500 bg-red-50 rounded-lg m-6">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p class="font-semibold text-lg">Gagal memuat data</p>
                <p id="admin-error-message" class="text-sm">Silakan coba lagi nanti.</p>
            </div>
            <div id="admin-no-data" class="hidden p-12 flex flex-col items-center justify-center text-gray-500">
                <i class="fas fa-folder-open text-4xl mb-4"></i>
                <p class="font-semibold text-lg">Belum ada data donasi.</p>
                <p class="text-sm">Jika Anda baru menerapkan filter, coba reset filter.</p>
            </div>

            <!-- Kontainer Tabel (Wrapper) -->
            <div id="admin-table-wrapper" class="hidden">
                <!-- Wrapper untuk tabel (horizontal scroll) -->
                <div class="table-wrapper">
                    <table class="w-full min-w-[1400px]">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Timestamp</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Jenis Donasi</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Nominal</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Donatur</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Detail Donatur</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Kontak</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Metode</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-200">
                            <!-- Baris data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                 <!-- Pagination -->
                <div class="flex justify-between items-center p-4 border-t border-gray-200">
                    <div>
                        <label for="pagination-rows" class="text-sm font-medium text-gray-700 mr-2">Baris per halaman:</label>
                        <select id="pagination-rows" class="border border-gray-300 rounded-lg p-2 shadow-sm focus:ring-orange-500 focus:border-orange-500 bg-white">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <span id="pagination-info" class="text-sm text-gray-600 font-medium"></span>
                    <div class="flex space-x-2">
                         <button id="pagination-prev" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-semibold hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                         <button id="pagination-next" class="bg-orange-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbydrhNmtJEk-lHLfrAzI8dG_uOZEKk72edPAEeL9pzVCna6br_hY2dAqDr-t8V5ost4/exec";

        // Elemen UI
        const loadingEl = document.getElementById('admin-loading');
        const errorEl = document.getElementById('admin-error');
        const errorMessageEl = document.getElementById('admin-error-message');
        const noDataEl = document.getElementById('admin-no-data');
        const tableWrapperEl = document.getElementById('admin-table-wrapper');
        const tableBodyEl = document.getElementById('table-body');
        const refreshButton = document.getElementById('refresh-button');
        const refreshIcon = document.getElementById('refresh-icon');
        
        // Statistik
        const statTotalEl = document.getElementById('admin-stat-total');
        const statDonaturEl = document.getElementById('admin-stat-donatur');
        const statTertinggiEl = document.getElementById('admin-stat-tertinggi');
        const statRataEl = document.getElementById('admin-stat-rata');
        const statHariIniEl = document.getElementById('admin-stat-hari-ini');
        const statTipeEl = document.getElementById('admin-stat-tipe');

        // Modal Alert
        const alertModal = document.getElementById('alert-modal');
        const alertModalIcon = document.getElementById('alert-modal-icon');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const alertModalClose = document.getElementById('alert-modal-close');

        // Modal Konfirmasi
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalOk = document.getElementById('confirm-modal-ok');
        
        // Modal Edit
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editModalClose = document.getElementById('edit-modal-close');
        const editModalCancel = document.getElementById('edit-modal-cancel');
        const editModalSave = document.getElementById('edit-modal-save');
        const editSaveText = document.getElementById('edit-save-text');
        const editSaveLoading = document.getElementById('edit-save-loading');
        
        // Filter
        const filterSearchEl = document.getElementById('filter-search');
        const filterDateFromEl = document.getElementById('filter-date-from');
        const filterDateToEl = document.getElementById('filter-date-to');
        const filterJenisEl = document.getElementById('filter-jenis');
        const filterTipeEl = document.getElementById('filter-tipe');
        const filterMetodeEl = document.getElementById('filter-metode');
        const filterApplyBtn = document.getElementById('filter-apply-button');
        const filterResetBtn = document.getElementById('filter-reset-button');
        const exportCsvBtn = document.getElementById('export-csv-button');

        // Pagination
        const paginationRowsEl = document.getElementById('pagination-rows');
        const paginationInfoEl = document.getElementById('pagination-info');
        const paginationPrevBtn = document.getElementById('pagination-prev');
        const paginationNextBtn = document.getElementById('pagination-next');

        // State (Data)
        let allDonationData = []; // Cache data mentah dari server
        let filteredData = []; // Data setelah filter diterapkan
        let paginatedData = []; // Data yang tampil di halaman saat ini
        let confirmCallback = null;
        let currentPage = 1;
        let rowsPerPage = 50;

        // Formatter Mata Uang
        const formatter = new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0,
        });

        // === FUNGSI MODAL ===

        function showModal(modalEl) {
            modalEl.classList.remove('hidden');
            setTimeout(() => {
                modalEl.classList.remove('opacity-0');
                modalEl.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideModal(modalEl) {
            modalEl.classList.add('opacity-0');
            modalEl.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalEl.classList.add('hidden');
            }, 250);
        }

        function showAppAlert(message, isError = false) {
            alertModalMessage.textContent = message;
            if (isError) {
                alertModalTitle.textContent = "Error";
                alertModalIcon.className = "fas fa-exclamation-triangle text-4xl text-red-500 mb-4";
            } else {
                alertModalTitle.textContent = "Sukses";
                alertModalIcon.className = "fas fa-check-circle text-4xl text-green-500 mb-4";
            }
            showModal(alertModal);
        }

        function showAppConfirm(message, callback) {
            confirmModalMessage.textContent = message;
            confirmCallback = callback;
            showModal(confirmModal);
        }

        // Event Listener Modal
        alertModalClose.addEventListener('click', () => hideModal(alertModal));
        confirmModalCancel.addEventListener('click', () => hideModal(confirmModal));
        editModalClose.addEventListener('click', () => hideModal(editModal));
        editModalCancel.addEventListener('click', () => hideModal(editModal));
        
        confirmModalOk.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideModal(confirmModal);
        });

        // === FUNGSI UTAMA (DATA & RENDER) ===

        async function fetchData() {
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            noDataEl.classList.add('hidden');
            tableWrapperEl.classList.add('hidden');
            refreshIcon.classList.add('fa-spin'); // Mulai animasi refresh

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'GET',
                    redirect: 'follow'
                });
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const result = await response.json();
                if (result.status !== "success") {
                    throw new Error(result.message || "Script mengembalikan status error.");
                }
                
                // Simpan data mentah
                allDonationData = result.data.sort((a, b) => b.row - a.row); // Terbaru di atas
                
                // Isi dropdown filter (hanya sekali)
                populateFilterDropdowns(allDonationData);
                
                // Terapkan filter (yang akan me-render tabel dan statistik)
                applyFilters();

            } catch (error) {
                console.error("Error fetching data:", error);
                errorMessageEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
                refreshIcon.classList.remove('fa-spin'); // Hentikan animasi refresh
            }
        }

        function calculateStatistics(data) {
            const totalDonasi = data.reduce((acc, row) => acc + (parseFloat(row.Nominal) || 0), 0);
            const totalDonatur = data.length;
            const donasiTertinggi = data.reduce((max, row) => Math.max(max, parseFloat(row.Nominal) || 0), 0);
            const donasiRataRata = totalDonatur > 0 ? (totalDonasi / totalDonatur) : 0;
            
            // Cek donasi hari ini (berdasarkan filter tanggal, jika ada)
            const dateFrom = filterDateFromEl.valueAsDate;
            const dateTo = filterDateToEl.valueAsDate;
            const today = new Date().setHours(0, 0, 0, 0);
            
            let donasiHariIni = 0;
            // Hanya hitung stat "Hari Ini" jika filter tanggal tidak aktif
            if (!dateFrom && !dateTo) {
                 donasiHariIni = data
                    .filter(row => new Date(row.Timestamp).setHours(0, 0, 0, 0) === today)
                    .reduce((acc, row) => acc + (parseFloat(row.Nominal) || 0), 0);
            }

            const tipeCounts = data.reduce((acc, row) => {
                const tipe = row.TipeDonatur || 'Lainnya';
                acc[tipe] = (acc[tipe] || 0) + 1;
                return acc;
            }, {});

            let tipeTerbanyak = '-';
            let maxCount = 0;
            for (const tipe in tipeCounts) {
                if (tipeCounts[tipe] > maxCount) {
                    maxCount = tipeCounts[tipe];
                    tipeTerbanyak = tipe.charAt(0).toUpperCase() + tipe.slice(1);
                }
            }

            statTotalEl.textContent = formatter.format(totalDonasi);
            statDonaturEl.textContent = totalDonatur;
            statTertinggiEl.textContent = formatter.format(donasiTertinggi);
            statRataEl.textContent = formatter.format(donasiRataRata);
            statHariIniEl.textContent = formatter.format(donasiHariIni);
            statTipeEl.textContent = tipeTerbanyak;
        }

        function renderTable() {
            // 1. Hitung data untuk halaman ini
            rowsPerPage = parseInt(paginationRowsEl.value, 10);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            paginatedData = filteredData.slice(startIndex, endIndex);

            // 2. Kosongkan tabel
            tableBodyEl.innerHTML = '';
            
            // 3. Cek jika tidak ada data
            if (filteredData.length === 0) {
                noDataEl.classList.remove('hidden');
                tableWrapperEl.classList.add('hidden');
                return;
            }
            
            noDataEl.classList.add('hidden');
            tableWrapperEl.classList.remove('hidden');

            // 4. Render baris data
            paginatedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                
                const timestamp = new Date(row.Timestamp).toLocaleString('id-ID', {
                    day: '2-digit', month: 'short', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                let detailDonatur = '-';
                if (row.TipeDonatur === 'santri' && row.NamaSantri) {
                    detailDonatur = `<span class="font-semibold">${row.NamaSantri}</span><br><span class="text-xs text-gray-500">NIS: ${row.NISSantri || '-'} | Kls: ${row.KelasSantri || '-'}</span>`;
                } else if (row.TipeDonatur === 'alumni' && row.DetailAlumni) {
                    detailDonatur = `<span class="font-semibold">${row.DetailAlumni}</span>`;
                } else if (row.TipeDonatur === 'umum') {
                    detailDonatur = `<span class="text-xs text-gray-500">Umum</span>`;
                }

                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${timestamp}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${row.JenisDonasi || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-semibold text-orange-600 text-sm">${formatter.format(row.Nominal || 0)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${row.NamaDonatur || '-'}</td>
                    <td class="px-4 py-3 text-sm">${detailDonatur}</td>
                    <td class="px-4 py-3 text-sm">
                        ${row.NoHP ? `<span class="block text-xs">${row.NoHP}</span>` : ''}
                        ${row.Email ? `<span class="block text-xs">${row.Email}</span>` : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${row.MetodePembayaran || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 transition-colors mr-3" data-row="${row.row}" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700 transition-colors" data-row="${row.row}" title="Hapus">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tableBodyEl.appendChild(tr);
            });
            
            // 5. Update info pagination
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            paginationInfoEl.textContent = `Halaman ${currentPage} dari ${totalPages || 1} (${filteredData.length} data)`;
            paginationPrevBtn.disabled = currentPage === 1;
            paginationNextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // === FUNGSI FILTER & PAGINATION ===

        function populateFilterDropdowns(data) {
            const jenisSet = new Set();
            const tipeSet = new Set();
            const metodeSet = new Set();

            data.forEach(row => {
                if (row.JenisDonasi) jenisSet.add(row.JenisDonasi);
                if (row.TipeDonatur) tipeSet.add(row.TipeDonatur);
                if (row.MetodePembayaran) metodeSet.add(row.MetodePembayaran);
            });

            // Hapus opsi lama (kecuali "Semua")
            filterJenisEl.innerHTML = '<option value="">Semua Jenis</option>';
            filterTipeEl.innerHTML = '<option value="">Semua Tipe</option>';
            filterMetodeEl.innerHTML = '<option value="">Semua Metode</option>';

            jenisSet.forEach(val => filterJenisEl.add(new Option(val, val)));
            tipeSet.forEach(val => filterTipeEl.add(new Option(val.charAt(0).toUpperCase() + val.slice(1), val)));
            metodeSet.forEach(val => filterMetodeEl.add(new Option(val, val)));
        }

        function applyFilters() {
            const searchTerm = filterSearchEl.value.toLowerCase();
            const dateFrom = filterDateFromEl.valueAsDate;
            const dateTo = filterDateToEl.valueAsDate;
            const jenis = filterJenisEl.value;
            const tipe = filterTipeEl.value;
            const metode = filterMetodeEl.value;
            
            // Koreksi Tanggal 'Sampai' (agar inklusif sampai akhir hari)
            if (dateTo) {
                dateTo.setHours(23, 59, 59, 999);
            }
             if (dateFrom) {
                dateFrom.setHours(0, 0, 0, 0);
            }

            filteredData = allDonationData.filter(row => {
                const timestamp = new Date(row.Timestamp);
                
                // Filter Tanggal
                if (dateFrom && timestamp < dateFrom) return false;
                if (dateTo && timestamp > dateTo) return false;
                
                // Filter Dropdown
                if (jenis && row.JenisDonasi !== jenis) return false;
                if (tipe && row.TipeDonatur !== tipe) return false;
                if (metode && row.MetodePembayaran !== metode) return false;
                
                // Filter Search
                if (searchTerm) {
                    const nama = (row.NamaDonatur || '').toLowerCase();
                    const nis = (row.NISSantri || '').toLowerCase();
                    const hp = (row.NoHP || '').toLowerCase();
                    const email = (row.Email || '').toLowerCase();
                    if (!nama.includes(searchTerm) && !nis.includes(searchTerm) && !hp.includes(searchTerm) && !email.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });

            // Update statistik berdasarkan data yang difilter
            calculateStatistics(filteredData);
            
            // Reset ke halaman 1 dan render tabel
            currentPage = 1;
            renderTable();
        }

        function resetFilters() {
            filterSearchEl.value = '';
            filterDateFromEl.value = '';
            filterDateToEl.value = '';
            filterJenisEl.value = '';
            filterTipeEl.value = '';
            filterMetodeEl.value = '';
            
            // Terapkan filter (yang akan me-reset semuanya)
            applyFilters();
        }

        // Event Listener Filter
        filterApplyBtn.addEventListener('click', applyFilters);
        filterResetBtn.addEventListener('click', resetFilters);
        
        // Event Listener Pagination
        paginationRowsEl.addEventListener('change', () => {
            currentPage = 1; // Reset ke halaman pertama saat ganti jumlah baris
            renderTable();
        });
        paginationPrevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
        paginationNextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // === FUNGSI AKSI (EDIT, HAPUS, EKSPOR) ===

        function openEditModal(rowNumber) {
            const dataToEdit = allDonationData.find(row => row.row === rowNumber);
            if (!dataToEdit) {
                showAppAlert("Data tidak ditemukan.", true);
                return;
            }

            // Isi formulir
            document.getElementById('edit-row-number').value = dataToEdit.row;
            document.getElementById('edit-JenisDonasi').value = dataToEdit.JenisDonasi || '';
            document.getElementById('edit-Nominal').value = dataToEdit.Nominal || 0;
            document.getElementById('edit-MetodePembayaran').value = dataToEdit.MetodePembayaran || 'Transfer';
            document.getElementById('edit-NamaDonatur').value = dataToEdit.NamaDonatur || '';
            document.getElementById('edit-TipeDonatur').value = dataToEdit.TipeDonatur || 'umum';
            document.getElementById('edit-DetailAlumni').value = dataToEdit.DetailAlumni || '';
            document.getElementById('edit-NamaSantri').value = dataToEdit.NamaSantri || '';
            document.getElementById('edit-NISSantri').value = dataToEdit.NISSantri || '';
            document.getElementById('edit-KelasSantri').value = dataToEdit.KelasSantri || '';
            document.getElementById('edit-NoHP').value = dataToEdit.NoHP || '';
            document.getElementById('edit-Alamat').value = dataToEdit.Alamat || '';
            document.getElementById('edit-Email').value = dataToEdit.Email || '';
            document.getElementById('edit-NoKTP').value = dataToEdit.NoKTP || '';
            document.getElementById('edit-PesanDoa').value = dataToEdit.PesanDoa || '';

            showModal(editModal);
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            editModalSave.disabled = true;
            editSaveText.classList.add('hidden');
            editSaveLoading.classList.remove('hidden');

            const rowNumber = document.getElementById('edit-row-number').value;
            const payload = {
                Timestamp: "", // Akan di-handle oleh Apps Script
                JenisDonasi: document.getElementById('edit-JenisDonasi').value,
                Nominal: parseFloat(document.getElementById('edit-Nominal').value) || 0,
                MetodePembayaran: document.getElementById('edit-MetodePembayaran').value,
                NamaDonatur: document.getElementById('edit-NamaDonatur').value,
                TipeDonatur: document.getElementById('edit-TipeDonatur').value,
                DetailAlumni: document.getElementById('edit-DetailAlumni').value,
                NamaSantri: document.getElementById('edit-NamaSantri').value,
                NISSantri: document.getElementById('edit-NISSantri').value,
                KelasSantri: document.getElementById('edit-KelasSantri').value,
                NoHP: document.getElementById('edit-NoHP').value,
                Alamat: document.getElementById('edit-Alamat').value,
                Email: document.getElementById('edit-Email').value,
                NoKTP: document.getElementById('edit-NoKTP').value,
                PesanDoa: document.getElementById('edit-PesanDoa').value
            };

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "update", row: rowNumber, payload: payload }),
                    redirect: "follow"
                });

                const result = await response.json();
                if (result.status !== "success") {
                    throw new Error(result.message || "Gagal memperbarui data.");
                }

                hideModal(editModal);
                showAppAlert(`Data baris ${rowNumber} berhasil diperbarui.`);
                fetchData(); // Muat ulang semua data

            } catch (error) {
                console.error("Error updating data:", error);
                showAppAlert(`Gagal memperbarui data: ${error.message}`, true);
            } finally {
                editModalSave.disabled = false;
                editSaveText.classList.remove('hidden');
                editSaveLoading.classList.add('hidden');
            }
        }

        async function executeDelete(rowNumber) {
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "delete", row: rowNumber }),
                    redirect: "follow"
                });

                const result = await response.json();
                if (result.status !== "success") {
                    throw new Error(result.message || "Gagal menghapus data.");
                }
                showAppAlert(`Data baris ${rowNumber} berhasil dihapus.`);
                fetchData(); // Muat ulang semua data

            } catch (error) {
                console.error("Error deleting data:", error);
                showAppAlert(`Gagal menghapus data: ${error.message}`, true);
            }
        }

        function exportToCSV() {
            if (filteredData.length === 0) {
                showAppAlert("Tidak ada data untuk diekspor. Coba reset filter Anda.", true);
                return;
            }

            // Ambil header dari data pertama (lebih aman)
            const headers = Object.keys(filteredData[0]);
            
            // Ganti 'row' dengan 'RowNumber' agar lebih jelas di Excel
            const csvHeaders = headers.map(h => h === 'row' ? 'RowNumber' : h).join(',');

            const csvRows = filteredData.map(row => {
                return headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : row[header];
                    // Ubah jadi string dan escape tanda kutip
                    let cellString = String(cell);
                    // Jika ada koma, tanda kutip, atau baris baru, bungkus dengan tanda kutip
                    if (cellString.includes(',') || cellString.includes('"') || cellString.includes('\n')) {
                        cellString = `"${cellString.replace(/"/g, '""')}"`;
                    }
                    return cellString;
                }).join(',');
            });

            const csvContent = [csvHeaders, ...csvRows].join('\n');
            
            // Buat file dan download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const tgl = new Date().toISOString().split('T')[0];
            link.setAttribute('download', `Ekspor_Donasi_Lazismu_${tgl}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === Event Listener Global ===

        refreshButton.addEventListener('click', fetchData);
        exportCsvBtn.addEventListener('click', exportToCSV);
        editForm.addEventListener('submit', handleEditSubmit);
        
        // Event listener untuk tombol Edit/Hapus di tabel
        tableWrapperEl.addEventListener('click', function(event) {
            const target = event.target.closest('button');
            if (!target) return;

            const rowNumber = parseInt(target.getAttribute('data-row'));

            if (target.classList.contains('edit-btn')) {
                openEditModal(rowNumber);
            }
            
            if (target.classList.contains('delete-btn')) {
                showAppConfirm(`Anda yakin ingin menghapus data donasi di baris ${rowNumber}?`, () => {
                    executeDelete(rowNumber);
                });
            }
        });

        // Muat data saat halaman pertama kali dibuka
        fetchData();
    </script>
</body>
</html>